version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Starting build for branch: $AWS_BRANCH"
        # Determine the application directory and export it
        - if [ "$AWS_BRANCH" = "master" ]; then export app_dir="frontend"; else export app_dir="landing-page"; fi
        - echo "Changing directory to $app_dir"
        # Change directory
        - cd $app_dir
        # Determine the artifact directory *relative to the app_dir* and export it
        - if [ "$AWS_BRANCH" = "master" ]; then export ARTIFACT_DIR="dist"; else export ARTIFACT_DIR=".next"; fi
        - echo "Artifact directory set to: $ARTIFACT_DIR"
        # Install dependencies within the app directory
        - npm install
    build:
      commands:
        - echo "Running build command in $(pwd)..."
        # Build command runs within the app directory
        - npm run build
  artifacts:
    # Use the environment variable determined in preBuild. YAML handles simple $VAR substitution fine.
    baseDirectory: $ARTIFACT_DIR
    files:
      - '**/*'
  cache:
    paths:
      # Cache path is relative to the final working directory ($app_dir)
      - node_modules/**/*